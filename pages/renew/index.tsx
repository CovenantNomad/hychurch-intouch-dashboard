import dayjs from "dayjs";
import type {NextPage} from "next";
import Head from "next/head";
import {useCallback, useEffect, useState} from "react";
import {useRecoilState} from "recoil";
import graphlqlRequestClient from "../../client/graphqlRequestClient";
import SectionContainer from "../../components/Atoms/Container/SectionContainer";
import TabsWithHeader from "../../components/Atoms/Tabs/TabsWithHeader";
import Layout from "../../components/Layout/Layout";
import PageLayout from "../../components/Layout/PageLayout";
import GradeDMember from "../../components/Templates/Renew/GradeDMember";
import GradeEMember from "../../components/Templates/Renew/GradeEMember";
import GradeFMember from "../../components/Templates/Renew/GradeFMember";
import GradeGMember from "../../components/Templates/Renew/GradeGMember";
import RenewAttendance from "../../components/Templates/Renew/RenewAttendance";
import RenewTransfer from "../../components/Templates/Renew/RenewTransfer";
import {
  FindRenewCellQuery,
  FindRenewCellQueryVariables,
  useFindRenewCellQuery,
  UserCellTransferStatus,
  UserGrade,
} from "../../graphql/generated";
import {SpecialCellIdType} from "../../interface/cell";
import {MemberWithTransferOut} from "../../interface/user";
import {stateSetting} from "../../stores/stateSetting";
import {getTodayString} from "../../utils/dateUtils";

const ReNewPage: NextPage = () => {
  const now = dayjs();
  const [setting, setSetting] = useRecoilState(stateSetting);
  const [categoryId, setCategoryId] = useState<number>(
    setting.renewSelectedCategoryId
  );
  const [gradeDList, setGradeDList] = useState<MemberWithTransferOut[]>([]);
  const [gradeEList, setGradeEList] = useState<MemberWithTransferOut[]>([]);
  const [gradeFList, setGradeFList] = useState<MemberWithTransferOut[]>([]);
  const [gradeGList, setGradeGList] = useState<MemberWithTransferOut[]>([]);
  const [datafilter, setDatafilter] = useState({
    min: getTodayString(now.subtract(1, "year")),
    max: getTodayString(now),
  });

  const categories = [
    {
      id: 0,
      name: "D등급",
      component: <GradeDMember memberList={gradeDList} />,
    },
    {
      id: 1,
      name: "E등급",
      component: <GradeEMember memberList={gradeEList} />,
    },
    {
      id: 2,
      name: "F등급",
      component: <GradeFMember memberList={gradeFList} />,
    },
    {
      id: 3,
      name: "G등급",
      component: <GradeGMember memberList={gradeGList} />,
    },
    {id: 4, name: "새싹셀 편성", component: <RenewTransfer />},
    {id: 5, name: "새싹셀 출석체크", component: <RenewAttendance />},
  ];

  const {isLoading, data} = useFindRenewCellQuery<
    FindRenewCellQuery,
    FindRenewCellQueryVariables
  >(
    graphlqlRequestClient,
    {
      id: Number(SpecialCellIdType.Renew),
      transferOutStatus: [UserCellTransferStatus.Ordered],
      transferOutDateFilter: {
        between: {
          min: datafilter.min,
          max: datafilter.max,
        },
      },
    },
    {
      staleTime: 10 * 60 * 1000,
      cacheTime: 30 * 60 * 1000,
    }
  );

  useEffect(() => {
    if (data) {
      const memberTemp = data.findCell.members.filter(
        (item) => item.roles.length === 0
      );
      const blessingWithTransfer = memberTemp.map((member) => {
        let findInfo = data.findCell.transfersOut.find(
          (item) => item.user.id === member.id
        );
        return data.findCell.transfersOut.find(
          (item) => item.user.id === member.id
        )
          ? {
              ...member,
              transferStatus: findInfo?.status,
              toCellId: findInfo?.toCell.id,
              toCellName: findInfo?.toCell.name,
              orderDate: findInfo?.orderDate,
            }
          : member;
      });

      setGradeDList(
        blessingWithTransfer.filter((member) => member.grade === UserGrade.D)
      );

      setGradeEList(
        blessingWithTransfer.filter((member) => member.grade === UserGrade.E)
      );
      setGradeFList(
        blessingWithTransfer.filter((member) => member.grade === UserGrade.F)
      );
      setGradeGList(
        blessingWithTransfer.filter((member) => member.grade === UserGrade.G)
      );
    }
  }, [data]);

  const setSettingHandler = useCallback(
    (id: number) => {
      setSetting({
        ...setting,
        renewSelectedCategoryId: id,
      });
    },
    [setting, setSetting]
  );

  return (
    <Layout>
      <Head>
        <title>새싹셀 | INTOUCH CHURCH</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <PageLayout>
        <TabsWithHeader
          title={"새싹셀"}
          tabs={categories}
          currentTab={categoryId}
          setCurrentTab={setCategoryId}
          setSettingHandler={setSettingHandler}
        />
        <SectionContainer>{categories[categoryId].component}</SectionContainer>
      </PageLayout>
    </Layout>
  );
};

export default ReNewPage;
